## Reproduction Process

First, download the latest source code from the official website:
![](attachment/c87de8eaca709c4c5de03cbd32063232.png)
After downloading, use PHPStudy Pro to set up the website:
![](attachment/8b9f2db0090cf6b73a7f94c0d167ce22.png)
Proceed with the installation process, setting up the database information and admin password:
![](attachment/fbc4730a9531b0e0fb2a5767dc563add.png)
In the admin panel, verify that the current version is the latest:
![](attachment/12354845fcfca41f173efd5a1a2617db.png)
Prepare a malicious payload in the form of an image, utilizing Remote Code Execution (RCE) via template file inclusion:

```
GIF89a
<?php phpinfo();?>
```
![](attachment/e189500caab549f41f3446e544d7bb37.png)
Upload the image payload:
![](attachment/a205a26d36191d7e313c05d30536d701.png)
Choose the WeChat public account interface:
![](attachment/214547360711847f4cfa5dd4321ea3cb.png)
Proceed with the upload and obtain the returned path:
![](attachment/33be3daa3c8f973a04dd0c6f3fd120a3.png)

```
uploads/allimg/20230901/1-230Z1151QR14.gif
```
Return to the template configuration, set up security questions:
![](attachment/e37f5a830120eea28d699de8f4f3b184.png)
After configuring security questions, edit the "index.htm" template under the PC section:
![](attachment/c775901e02f980a849c7cff119c1ec03.png)Input the following payload:

```
{eyou:include file="uploads/allimg/20230901/1-230Z1151QR14.gif" /}
```
Append it at the end:
![](attachment/8a6ba059c05ff86c85cfb0e317a00ad7.png)
After submission:
![](attachment/ae47e76c9121e06c8157fdfe00b26e2d.png)
Return to the homepage, where arbitrary code execution can be observed:
![](attachment/027f90d904791008de0a5efade58c67c.png)

## Code Audit
Firstly, the `eyou:include` tag is present in the list of parsed tags, and there is no filtering mechanism applied to it:
```
core\library\think\Template.php
```
![](attachment/2c8d8d6c6f1532e6455a0375826128c8.png)
The template file "index.htm" is read and stored in the `$content` variable. Parsing takes place in "core\library\think\Template.php":![](attachment/5344a863df65ba52c53bc2df0af1eba1.png)
We can observe the `parseEyouInclude` function:
![](attachment/d9286dec9ecc0e8aac746c52d24d3e96.png)
Inside this function, the template is analyzed and processed, where we can see that only string operations are performed, and no security risk evaluation is conducted:![](attachment/c33195d0a6d219608b7ec255dee5ea2d.png)
Finally, at the end, the tags are replaced and returned:
![](attachment/ccf4013d9dab5f75e5146d3c06439a52.png)
Due to the absence of security filtering, the include tag's parsing result directly reads and replaces content:
![](attachment/5b971cb11f52fc3ac36c88356cef8b4d.png)
Similarly, in the "Template.php" file, writing to the cache occurs:
![](attachment/fd569e5ec351f67102ccfc29440cb189.png)
Digging deeper:

```
core\library\think\template\driver\File.php
```
In the `write` method, content is directly written:
![](attachment/f976584f75b62862e781ba23c27a1d80.png)
Cache directory:
![](attachment/1fea73c40c03331267818742871735d5.png)
Ultimately, in the `read` method of "File.php," the temporarily generated file is included, leading to Remote Code Execution (RCE):

```
core\library\think\template\driver\File.php
```
![](attachment/a16798051f7d955002557d7216537d9f.png)